<template>
    <div class='rc-panel rc-conversation'>
        <div class='rc-panel__header --colored' data-info='header'>
            <contact-picker data-info='contact-picker'></contact-picker>
        </div>
        <div    class='rc-panel__content rc-conversation__container' 
                data-info='panel'>
            <dropdown class='' data-info='dropdown'></dropdown>
            <div    class='rc-conversation__content' 
                    data-info='container'
                    data-event='scroll:scroll'>
                <div    class='conversations__loading display-none'
                        data-info='loading'>
                    loading...
                </div>
                <div    class='conversations' 
                        data-info='conversations'>
                </div>
            </div>
            <div class='rc-conversation__textarea-wrapper'>
                <textarea 
                data-info='input' 
                data-event='keydown:enter'
                placeholder='messages...'
                ></textarea>
            </div>
        </div>
    </div>
</template>
<script>
w.register(function() {
    var fade = w.transition('fade')
    this.actions = {
        init: {
            method: function() {
               
            },
            after: function() {
                var conversation = this;
                w.customize(this, 'contact-picker', {
                    data: {
                        contact: conversation.data.toNumber
                    },
                    actions: {
                        autoComplete: {
                            method: function() {
                                return conversation.queryContacts(this.props.inputValue);
                            }
                        }
                    }
                })
                w.customize(this, 'dropdown', {
                    data: {
                        defaultValue: conversation.data.fromNumber
                    },
                    actions: {
                        getData: {
                            method: function() {
                                return conversation.getOutboundCallerID();
                            },
                            after: function(ids) {
                                ids.forEach(id => this.addItem(id));
                            }
                        },
                        switchTitle: {
                            method: function(text) {
                                conversation.props.fromNumber = text;
                            }
                        }
                    }
                })
            }
        },
        mount: {
            method: function() {
                // There is two type of conversation: 1. to new users 2. existing conversation
                // will be determined by this.data
                if (!this.data.new) {
                    this.refs['contact-picker'].disable()
                    this.refs.dropdown.disable()
                }
            },
            after: function() {
                this.refs['dropdown'].getData()
                this.dom.input.value = this.data.message || ''
                fade.init(this.root)
                fade.in(this.root, {
                    after: () => this.refs['contact-picker'].focus()
                })
            }
        },
        enter: {
            method: function(finish, e) {
                if (e.keyCode === 13) {
                    this.send()
                    e.preventDefault()
                }
            }
        },
        send: {
            before: function() {
                // send messages on UI
                this.props.message = this.dom.input.value
                this.dom.input.value = ''
                var date = new Date()
                var bubble = this.addBubble(
                    this.props.message,
                    'Outgoing',
                    `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`)
                this.scrollToBottom()
                return bubble
            },
            method: function(finish, dom) {
                this.props.fromNumber = this.data.fromNumber || this.props.fromNumber
                this.props.toNumber = this.data.toNumber || this.refs['contact-picker'].dom.input.value
                return finish().then(response => {
                    dom.setAttribute('data-id', response.id)
                    this.unconfirm = this.unconfirm || []
                    this.unconfirm.push(dom)
                    return response
                }).catch(err => dom.parentNode.removeChild(dom))
                // user actually send to message to server (SDK)
            },
            after: function(response) {}
        },
        addBubble: {
            after: function(text, direction, time, prepend) {
                var opponent = (direction === 'Inbound')
                var template = `<div class='clearfix'>
                                    <div
                                        data-tooltip='${time}' 
                                        class='conversations__bubble ${opponent? "--opponent": "--self"} '>
                                        ${text}
                                    </div>
                                </div>`
                var div = document.createElement('div')
                div.innerHTML = template
                if (prepend) {
                    this.dom.conversations.insertBefore(
                        div.childNodes[0],
                        this.dom.conversations.firstChild
                    )
                } else {
                    this.dom.conversations.appendChild(
                        div.childNodes[0]
                    )
                }
                return this.dom.conversations.lastChild;
            }
        },
        disable: {
            after: function() {
                this.refs['contact-picker'].disable()
                this.refs.dropdown.disable()
            }
        },
        scroll: {
            method: function(finish, event) {
                if (event.target.scrollTop === 0)
                    this.reachTop()
            }
        },
        reachTop: {
            before: function() {},
            method: function(finish) {
                if (this.isLoading)
                    return
                this.isLoading = true
                this.dom.loading.classList.remove('display-none')
                return finish().then(result => {
                    this.isLoading = false
                    this.dom.loading.classList.add('display-none')
                    return result
                })
            },
            after: function(messages) {
                if (messages) {
                    // maintain the scoll position
                    var scrollBottom = this.dom.conversations.offsetHeight
                    this.prependMessages(messages, false)
                    this.dom.container.scrollTop = 
                    this.dom.conversations.offsetHeight - scrollBottom
                }
            }
        },
        appendMessages: {
            method: function(finish, msgs, scroll) {
                if (msgs)
                    msgs
                    .map(msg => {
                        var time = new Date(msg.lastModifiedTime)
                        msg.time = `${time.getHours()}:${time.getMinutes()}:${time.getSeconds()}`
                        return msg
                    })
                    .forEach(msg => this.addBubble(
                        msg.subject,
                        msg.direction,
                        msg.time)
                    )
            },
            after: function(msgs, scroll = true) {
                if (scroll)
                    this.scrollToBottom()
            }
        },
        prependMessages: {
            before: function() {

            },
            method: function(finish, msgs, scroll) {
                if (msgs)
                    msgs
                    .map(msg => {
                        var time = new Date(msg.lastModifiedTime)
                        msg.time = `${time.getHours()}:${time.getMinutes()}:${time.getSeconds()}`
                        return msg
                    })
                    .forEach(msg => this.addBubble(
                        msg.subject,
                        msg.direction,
                        msg.time,
                        true)
                    )
            },
            after: function(msgs, scroll = true) {
                if (scroll)
                    this.scrollToBottom()
            }
        },
        warnBubble: {
            after: function(id) {

            }
        },
        scrollToBottom: {
            after: function() {
                this.dom.container.scrollTop = this.dom.container.scrollHeight
            }
        },
        getOutboundCallerID: {
            method: function(finish) {
                return finish();
            }
        },
        queryContacts: {
            method: function(finish, queryText) {
                this.props.to = queryText;
                return finish();
            }
        },
        addIncomingMessages: {
            method: function(finish, messages) {
                messages
                .filter(msg => msg.availability === 'Alive')
                .filter(msg => msg.messageStatus === 'Received')
                .filter(msg => msg.direction === 'Inbound')
                .filter(msg => msg.readStatus === 'Unread')
                .map(msg => {
                    console.log(msg);
                    var time = new Date(msg.lastModifiedTime)
                    msg.time = `${time.getHours()}:${time.getMinutes()}:${time.getSeconds()}`
                    return msg
                })
                .forEach(msg => this.addBubble(
                    msg.subject,
                    msg.direction,
                    msg.time)
                )
            },
            after: this.scrollToBottom
        },
        confirmMessages: {
            method: function(finish, messages) {
                if (!this.unconfirm)
                    return []
                if (!messages)
                    return []
                return this.unconfirm
                .filter(dom => messages
                    .map(msg => msg.id)
                    .indexOf(parseInt(dom.getAttribute('data-id'))) > -1)
                .forEach(dom => dom.removeAttribute('data-id'))
            }
        }
    }
})
//# sourceURL=conversation.html
</script>
