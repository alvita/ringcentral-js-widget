<template>
    <div data-info='panel' class='rc-panel rc-dial-pad'>
        <div class='rc-panel__header rc-panel__header--colored' data-info='header'>
            <contact-picker data-info='contact-picker'></contact-picker>
        </div>
        
        <div class='pad-container' data-info='container'>
            <div class='rc-panel__content'>
                <dropdown data-info='dropdown'></dropdown>
                <div data-info='dialing-panel' class='margin-top-1'>
                    <div class='rc-dial-pad__line'>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-1'>
                            <div class='dial-button__number'>1</div>
                        </button>
                        <button
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-2'>
                            <div class='dial-button__number'>2</div>
                            <div class='dial-button__symbol'>ABC</div>
                        </button>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-3'>
                            <div class='dial-button__number'>3</div>
                            <div class='dial-button__symbol'>DEF</div>
                        </button>
                    </div>
                    <div class='rc-dial-pad__line'>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-4'>
                            <div class='dial-button__number'>4</div>
                            <div class='dial-button__symbol'>GHI</div>
                        </button>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-5'>
                            <div class='dial-button__number'>5</div>
                            <div class='dial-button__symbol'>JKL</div>
                        </button>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-6'>
                            <div class='dial-button__number'>6</div>
                            <div class='dial-button__symbol'>MNO</div>
                        </button>
                    </div>
                    <div class='rc-dial-pad__line'>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-7'>
                            <div class='dial-button__number'>7</div>
                            <div class='dial-button__symbol'>PQRS</div>
                        </button>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-8'>
                            <div class='dial-button__number'>8</div>
                            <div class='dial-button__symbol'>TUV</div>
                        </button>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-9'>
                            <div class='dial-button__number'>9</div>
                            <div class='dial-button__symbol'>WXYZ</div>
                        </button>
                    </div>
                    <div class='rc-dial-pad__line'>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-*'>
                            <div class='dial-button__number'>*</div>
                        </button>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-0'>
                            <div class='dial-button__number'>0</div>
                            <div class='dial-button__symbol'>+</div>
                        </button>
                        <button 
                            class='rc-button rc-button--circle dial-button dial-button--color' 
                            data-info='dial-button-#'>
                            <div class='dial-button__number'>#</div>
                        </button>
                    </div>
                    <div data-info='callout-line' class='rc-dial-pad__line'>
                        <button 
                            class='rc-button 
                            rc-button--circle 
                            rc-dial-pad__call-button 
                            rc-dial-pad__call-button--color' 
                            data-info='callout'>
                            <span class='icon-ActionButtons_Filters'></span>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
        <div class='rc-dial-pad__mask display-none' data-info='disabled-mask'>
            <p data-info='disabled-mask-text'>Your account doesn't not have Web Phone permission.</p>
        </div>
        <div class='call-waiting' data-info='callWaiting'></div>
    </div>
</template>
<script>
this.data = {
    autoComplete: true,
    outboundID: true
}
this.props = {
    fromNumber: null,
    toNumber: null,
    isListenToKeyboard: false,
    remoteVideo: null,
    localVideo: null,
    pad: true
}
this.actions = {
    init: {
        before: function() {},
        method: function() {},
        after: function() {
            var dialPad = this
            var {color, lang, logo} = this.data
            this.props.remoteVideo = this.data.remoteVideo
            this.props.localVideo = this.data.localVideo
            this.data.pad && (this.props.pad = this.data.pad)
            if (!this.props.pad)
                this.dom.container.classList.add('display-none')
            w.customize(this, 'contact-picker', {
                data: {
                    whiteList: [
                        this.dom['dial-button-0'],
                        this.dom['dial-button-1'],
                        this.dom['dial-button-2'],
                        this.dom['dial-button-3'],
                        this.dom['dial-button-4'],
                        this.dom['dial-button-5'],
                        this.dom['dial-button-6'],
                        this.dom['dial-button-7'],
                        this.dom['dial-button-8'],
                        this.dom['dial-button-9'],
                    ]
                },
                actions: {
                    autoComplete: {
                        method: function() {
                            if (!dialPad.data.autoComplete)
                                return []
                            if (dialPad.props.toNumber !== this.dom.input.value)
                                dialPad.numberChange()
                            return dialPad.queryContacts(this.props.inputValue)
                        }
                    },
                    setInput: {
                        after: function() {
                            if (dialPad.props.toNumber !== this.dom.input.value)
                                dialPad.numberChange()
                        }
                    }
                }
            })
            w.customize(this, 'dropdown', {
                actions: {
                    getData: {
                        method: function() {
                            return dialPad.getOutboundCallerID()
                        }
                    },
                    switchTitle: {
                        method: function(text) {
                            dialPad.props.fromNumber = text
                        }
                    }
                }
            })
        }
    },
    mount: {
        before: function() {},
        method: function() {},
        after: function() {
            this.refs['dropdown'].getData()
            requestAnimationFrame(() => this.refs['contact-picker'].focus())
            if (!this.data.outboundID)
                this.dom.dropdown.classList.add('display-none')
            this.listenToKeyboard(true)
        }
    },
    unmount: {
        method: function(finish) {
            this.listenToKeyboard(false)
        }
    },
    dialing: {
        method: function(finish, value) {
            var cp = this.refs['contact-picker']
            cp.appendInput(value)
            cp.autoComplete()
            this.props.toNumber = cp.dom.input.value
            return finish()
        },
        after: function() {
            this.refs['contact-picker'].dom.input.focus()
        }
    },
    callout: {
        before: function() {
            // this.dom.callout.classList.add('rc-button--active')
            if (!this.props.toNumber || !this.props.fromNumber) {
                console.error('from- or to-Number is missing.')
                throw Error('from- or to-Number is missing.')
                return
            }
            var srcDOM = this.dom.callout
            return new Promise((resolve, reject) => {
                circle({
                    targetScene: this.dom.callWaiting,
                    srcDOM: this.dom.callout,
                    targetDOM: this.dom.callWaiting,
                    transitionEnd: () => {
                        srcDOM.style.top = 'auto'
                        srcDOM.style.left = 'auto'
                        // srcDOM.style.right = '5px'
                        srcDOM.style.width = '3.2em'
                        srcDOM.style.height = '3.2em'
                        srcDOM.style.background = '#2ecc71'
                        srcDOM.style.position = 'static'
                        // this.dom.callWaiting.style['z-index'] = 0
                        this.dom['callout-line'].appendChild(srcDOM)
                        resolve()
                    }
                })
            })
        },
        method: function(finish, event) {
            var cp = this.refs['contact-picker']
            this.props.toNumber = cp.dom.input.value
            return finish()
        },
        after: function() {
            
        },
        // error: function(err) {
        //     console.error(err);
        //     this.dom.callout.classList.remove('--active')
        // }
    },
    disable: {
        method: function(finish) {
            return finish()
        },
        after: function(message) {
            this.dom['disabled-mask'].classList.remove('display-none')
            this.dom['container'].classList.add('blur')
            if (message) {
                this.dom['disabled-mask-text'].textContent = message
            }
        }
    },
    getOutboundCallerID: {
        method: function(finish) {
            return finish()
        }
    },
    queryContacts: {
        method: function(finish, queryText) {
            this.props.toNumber = queryText
            return finish()
        }
    },
    number: {
        method: function(finish, value) {
            this.refs['contact-picker'].setInput(value)
            // avoid cyclic calling
            if (this.props.toNumber !== this.refs['contact-picker'].dom.input.value)
                this.numberChange()
        }
    },
    numberChange: {
        method: function(finish) {
            // fake event system
            this.props.toNumber = this.refs['contact-picker'].dom.input.value
        }
    },
    listenToKeyboard: {
        method: function(finish, value) {
            this.props.isListenToKeyboard = !!value
            return finish()
        }
    }
}
this.on('click', function(e) {
    [1, 2, 3, 4, 5, 6, 7, 8, 9, 0, '#', '*'].forEach(item => {
        if (e.target === this.dom[`dial-button-${item}`] ||
            e.target.parentNode === this.dom[`dial-button-${item}`]) this.dialing(item)
    })
    if (e.target === this.dom.callout ||
        e.target.parentNode === this.dom.callout) this.callout()
})
// this.on('keydown', 'document', function(e) {
//     if (!e.target.isEqualNode(this.refs['contact-picker'].dom.input) && 
//         this.props.isListenToKeyboard) {
//         this.dialing('')
//     }
// })


function transition({
    trans,
    layerHozTrans,
    layerVerticalTrans,
    initPosition,
    transitionStart,
    transitionTo,
    createLayer
}) {
    return function({ srcScene, targetScene, srcDOM, targetDOM, transitionEnd }) {
            if (targetScene) targetScene.style.display = 'block'
            let srcRect     = srcDOM.getBoundingClientRect()
            let targetRect  = targetDOM.getBoundingClientRect()
            let src = {
                width: srcDOM.offsetWidth,
                height: srcDOM.offsetHeight,
                left: srcRect.left,
                top: srcRect.top
            }
            console.log(src);
            let target = {
                width: targetDOM.offsetWidth,
                height: targetDOM.offsetHeight,
                left: targetRect.left,
                top: targetRect.top
            }
            
            let [$layer, $layer2] = createLayer({ src, target })
            let layer = div($layer, { overflow: 'hidden' })
            let layer2 = div($layer2, { position: 'fixed' })
            let clone = div(src, { position: 'absolute' })
            clone.style.marginBottom =  window.getComputedStyle(srcDOM).marginBottom
            clone.style.marginTop =  window.getComputedStyle(srcDOM).marginTop
            let dom = {
                src: srcDOM,
                target: targetDOM,
                layerHoz: layer,
                layerVertical: layer2
            }
            if (targetScene) targetScene.style.display = 'none'
            document.body.appendChild(layer2)
            srcDOM.parentNode.insertBefore(clone, srcDOM)
            layer2.appendChild(layer)
            layer.appendChild(srcDOM)
            srcDOM.style.position = 'absolute'
            srcDOM.style.transition = trans
            layer.style.transition = layerHozTrans
            layer2.style.transition = layerVerticalTrans
            transitionStart({ src, target, layerHoz: $layer, layerVertical: $layer2, dom })
            let callback = function() {
                if (targetScene) targetScene.style.display = 'block'
                layer2.parentNode.removeChild(layer2)
                clone.parentNode.removeChild(clone)
                transitionEnd()
            }
            setTimeout(() => transitionTo(
                callback , { src, target, layerHoz: $layer, layerVertical: $layer2, dom })
            , 17)
        }
}
function div(draft, { overflow = 'inherite', position = 'absolute' }) {
    var div = document.createElement('div')
    div.style.width = `${draft.width}px`
    div.style.height = `${draft.height}px`
    div.style.left = `${draft.left}px`
    div.style.top = `${draft.top}px`
    div.style.position = position
    div.style.overflow = overflow
    return div
}
var circle = transition({
    trans: 'all .375s cubic-bezier(0.4, 0.0, 0.2, 1)',
    layerHozTrans: 'all .1s ease-in',
    layerVerticalTrans: 'all .1s ease-out',
    transitionStart({ src, target, layerHoz, layerVertical, dom }) {
        var srcDOM = dom.src
        srcDOM.style.left = `${(layerHoz.width - src.width) / 2}px`
        srcDOM.style.top = `${(layerVertical.height - src.width) / 2}px`
    },
    transitionTo(finish, { src, target, layerHoz, layerVertical, dom }) {
        let srcDOM = dom.src
        let endedTransitions = 0
        let sl = Math.sqrt(
            (target.width / 2 * target.width / 2) +
            (target.height / 2 * target.height / 2)
        )
        srcDOM.style.position = 'absolute'
        srcDOM.style.width = sl * 2 + 'px'
        srcDOM.style.height = sl * 2 + 'px'
        srcDOM.style.left = target.width / 2 - sl + 'px'
        srcDOM.style.top = target.height / 2 - sl + 'px'
        srcDOM.style.background = '#fff'
        dom.layerHoz.style.left = target.left + 'px'
        dom.layerVertical.style.top = target.top + 'px'
        srcDOM.addEventListener('transitionend', function(e) {
            if (++ endedTransitions === 3) finish()
        })
    },
    createLayer({ src, target }) {
        return [{
            width: target.width,
            height: target.height,
            left: src.left - (target.width - src.width) / 2,
            top: 0,
        }, {
            width: target.width,
            height: target.height,
            left: 0,
            top: src.top - (target.height - src.height) / 2,
        }]
    }
})

//# sourceURL=dial-pad.html
</script>
<style>
@import "src/styles/variables.css";
@import "src/styles/mixins.css";
$dial-pad-button-radius: 3.2em;
$dial-pad-symbol-size: .5em;
$dial-pad-call-button-color: #2ecc71;
.rc-dial-pad {

    &__line {
        display: flex;
        flex-direction: row;
        justify-content: center;

        & > .dial-button {
            margin: 3px 6px;
            width:  $dial-pad-button-radius;
            height: $dial-pad-button-radius;
            color:          $main-color;
            border-color:   $main-color;

            & > .dial-button__number {
                font-size: 1.3em;
            }
            & > .dial-button__symbol {
                font-size: $dial-pad-symbol-size;
            }
            &:hover {
                background-color:   $main-color;
                color:              $white;
            }
        }
    }
    &__mask {
        position: absolute;
        display: flex;
        flex-direction: column;
        justify-content: center;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        > p {
            font-weight: bold;
            text-align: center;
        }
        &::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    }
    .call-waiting {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: $white;
        z-index: -1;
    }
    .blur {
        filter: blur(2px);
        -webkit-filter: blur(2px);
    }
    &__call-button {
        @mixin shadow-1;
        /*position: absolute;*/
        /*top:    5px;*/
        /*right:  5px;*/
        width:  3.2em;
        height: 3.2em;
        background-color:   $dial-pad-call-button-color;
        border-color:       $dial-pad-call-button-color;
        transition: all .08s cubic-bezier(0.4, 0.0, 0.2, 1);
        &:hover {
            @mixin shadow-2;
            background-color:   $dial-pad-call-button-color;
            border-color:       $dial-pad-call-button-color;
        }
        > span {
            color: $white;
            font-size: 1.3em;
        }
    }
    .pad-container {
        height: 100%;
    }
}


</style>
