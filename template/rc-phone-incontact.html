<div class='incontact'>
    <div data-info='auth-panel' class='auth-panel'></div>
    <div class='rc-panel main' data-info='main-panel' hidden>
        <div class='rc-panel__header'>
            <img class='logo' src="./ringcentral-logo.svg">
        </div>
        <div class='rc-panel__content'>
            <button class='logout' data-info='logout'>log out</button>
            <p data-info='waiting' class='waiting' hidden>
                Ready to receive calls
            </p>
            <input id='auto-receive' data-info='auto' type="checkbox"><label for='auto-receive'> auto receive call</label>
        </div>
        <div id='call-panel' class='overlap'></div>
        <div id='call-panel-incoming' class='overlap'></div>
    </div>
</div>
<script>
import Factory from './factory/factory'
import EventEmitter from './template/vendor/eventemitter'
var factory = new Factory()
w.register(function() {
    this.props = {
        ee: new EventEmitter(),
    },
    this.actions = factory.create('incontact', {
        init: {
            before: function() {
                this.props.key = this.data.key
                this.props.secret = this.data.secret
                this.props.sandbox = (this.data.sandbox === 'true')
            }
        },
        mount: {
            after: function() {
                var phone = this
                var authPanel = w('auth-panel', {
                    data: {
                        oauth: true
                    },
                    actions: factory.create('auth-panel', {
                        login: {
                            after: function() {
                                phone.dom['auth-panel'].hidden = true
                                this.unmount()
                                phone.dom.waiting.hidden = false
                                phone.dom['main-panel'].hidden = false
                                var incoming = webPhone(null, {
                                    width: phone.data.width,
                                    height: phone.data.height
                                }, phone)
                                this.dom.auto.addEventListener('click', () => {
                                    console.log(this.dom.auto)
                                    console.log(this.dom.auto.checked)
                                    incoming.auto(this.dom.auto.checked)
                                })
                                phone.props.ee.trigger('loggedin')
                            }
                        }
                    })
                })
                this.dom['logout'].addEventListener('click', (event) => {
                    this.logout()
                })
                authPanel.mount(this.dom['auth-panel'])
                this.checkLogin()
                .then(loggedin => {
                    console.log('check login', loggedin)
                    if (loggedin) {
                        phone.dom['auth-panel'].hidden = true
                        authPanel.unmount()
                        phone.dom.waiting.hidden = false
                        phone.dom['main-panel'].hidden = false
                        var incoming = webPhone(null, {
                            width: phone.data.width,
                            height: phone.data.height
                        }, phone)
                        this.dom.auto.addEventListener('click', () => {
                            console.log(this.dom.auto)
                            console.log(this.dom.auto.checked)
                            incoming.auto(this.dom.auto.checked)
                        })
                        phone.props.ee.trigger('loggedin')
                    } else {
                        
                    }
                })
                .catch(e => console.error(e))
            }
        },
        logout: {
            before: function() {
                console.log('logout')
                var authPanel = w('auth-panel', {
                    data: {
                        oauth: true
                    },
                    actions: factory.create('auth-panel', {
                        login: {
                            after: function() {
                                phone.dom['auth-panel'].hidden = true
                                this.unmount()
                                phone.dom.waiting.hidden = false
                                phone.dom['main-panel'].hidden = false
                                var incoming = webPhone(null, {
                                    width: phone.data.width,
                                    height: phone.data.height
                                }, phone)
                                this.dom.auto.addEventListener('click', () => {
                                    console.log(this.dom.auto)
                                    console.log(this.dom.auto.checked)
                                    incoming.auto(this.dom.auto.checked)
                                })
                                phone.props.ee.trigger('loggedin')
                            }
                        }
                    })
                })
                this.dom['auth-panel'].hidden = false
                authPanel.mount(this.dom['auth-panel'])
            }
        },
        setSize: {
            method: function() {}
        },
        on: {
            method: function(finish, event, callback) {
                this.props.ee.on(event, callback)
            }
        }
    })
})

var webPhone = function(data, {width, height}, phone) {
    var callPanel = w('call-panel', {
        data: {
            target: '#call-panel',
            width: width,
            height: height,
            advance: false
        },
        actions: factory.create('call-panel')
    })
    var callPanelIncoming = w('call-panel-incoming', {
        data: {
            target: '#call-panel-incoming',
            width: width,
            height: height,
            remoteVideo: callPanel.props.remoteVideo,
            localVideo: callPanel.props.localVideo,
            simple: true,
            autoReceive: false
        },
        actions: factory.create('call-panel-incoming', {
            init: {
                before: function() {
                    this.props.autoReceive = false
                }
            },
            accept: {
                after: function() {
                    this.unmount()
                    callPanel.setName(this.props.name)
                    callPanel.mount('#call-panel')
                    callPanel.start()
                }
            },
            auto: {
                before: function(flag = true) {
                    this.props.autoReceive = flag
                }
            },
            mount: {
                after: function() {
                    if (this.props.autoReceive) {
                        this.unmount()
                        callPanel.setName(this.props.name)
                        callPanel.mount('#call-panel')
                        callPanel.start()
                    } else {
                        phone.props.ee.trigger('incoming')
                    }
                }
            }
        })
    })
    return callPanelIncoming
}
</script>
<style>
    html, body {
      height: 100%;
      color: #333;
    }
    .incontact,
    .incontact .auth-panel {
      height: 100%;
    }
    .incontact .main {
        text-align: center;
        background-color: #fafafa;
    }
    .incontact .logo {
        margin-top: 10px;
        width: 60%;
    }
    .incontact .waiting {
        margin-top: 30px;
        text-align: center;
        font-size: 1.2em;
    }
    .incontact .overlap {
        position: absolute;
        top: 0;
        height: 100%;
    }
    .incontact .logout {
        position: fixed;
        top: 5px;
        right: 5px;
        font-size: 9px;
    }
    .incontact .auth-panel {
        position: relative;
        z-index: 2;
    }
</style>
