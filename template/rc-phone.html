<style>
@import "src/styles/variables.css";
@import "src/styles/mixins.css";
.rc-phone {
    position: relative;
    width: 250px;
    height: 100%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    margin: 0 auto;
    transition: height .150s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.rc-phone > .phone-container {
    width: 3000px;
    transition: transform .1s cubic-bezier(0.4, 0.0, 0.2, 1);
}
.rc-phone .panel {
    min-height: 1px;
}
.rc-phone .panel--extra {
    position: absolute;
    /* extra panel should have the highest z-index */
    /*z-index: 10;*/
    left: 0;
}
.rc-phone .auth-panel {
    position: absolute;
    /* overlap with container */
    z-index: 5;
}
.window {
    position: absolute;
    z-index: 5;
    top: 12px;
    left: 12px;
    /* need some space to fit the icon font */
    padding-right: 2px; 
    &__button {
        width: 12px;
        height: 12px;
        cursor: pointer;
        &--remove {
            color: $light-red;
        }
        &--resize {
            color: $light-yellow;
        }
        &--logout {
        }
    }
    &--right {
        left: auto;
        right: 3px;
        z-index: 2;
    }
}
</style>
<div>
    <div class='window'>
        <span data-info='remove' class='icon-RC_close2 window__button window__button--remove'></span>
        <span data-info='resize' class='icon-RC_status window__button window__button--resize'></span>
    </div>
    
    <div data-info='phone' id='phone' class='rc-phone'>
        <div class='window window--right'>
            <span data-info='logout' class='icon-RC_Logout window__button window__button--logout'></span>
        </div>
        <div data-info='auth-panel' id="auth-panel" class='auth-panel'></div>
        <div data-info='toolbar' id="toolbar"></div>
        <div class='phone-container' data-info='container'>
        </div>
        <div data-info='conversation' class='panel panel--extra' id="conversation"></div>
        <div data-info='call-panel' class='panel panel--extra' id="call-panel"></div>
        <div data-info='call-panel-incoming' class='panel panel--extra' id="call-panel-incoming"></div>
        <div data-info='contact-detail' class='panel panel--extra' id="contact-detail"></div>
        <div data-info='notification' class='panel panel--extra' id="notification"></div>
    </div>
</div>
<script src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js'></script>
<!-- <script src="./build/factory.js"></script> -->
<script>
/*
* Events:
* 1. resize
* 2. dialing
* 3. ready
* 4. unmount
*/
import Factory from './factory/factory'
import EventEmitter from './template/vendor/eventemitter'
w.register(function() {
    var factory = new Factory()
    this.data = {
        width: 250,
        originalHeight: 400,
    }
    this.props = {
        panels: [],
        width: 250,
        originalHeight: 400,
        minimizedHeight: 100,
        height: 400,
        toolbarHeight: 40,
        key: null,
        secret: null,
        ee: new EventEmitter()
    }
    this.actions = factory.create('rcPhone', {
        on: {
            method: function(finish, event, callback) {
                this.props.ee.on(event, callback)
            }
        },
        resize: {
            before: function() {

            },
            after: function(height) {
                var newHeight
                if (height) 
                    newHeight = height
                else if (this.props.height === this.props.minimizedHeight)
                    newHeight = this.props.originalHeight
                else
                    newHeight = this.props.minimizedHeight
                this.props.ee.trigger('resize', [this.props.width, newHeight])
            }
        },
        setSize: {
            method: function(finish, width, height) {
                this.props.width = width
                this.props.height = height
                this.dom.phone.style.width = this.props.width + 'px'
                this.dom.phone.style.height = this.props.height + 'px'
            }
        },
        init: {
            before: function() {
                this.props.cachedMessageHours = 7 * 24
                this.props.originalHeight = this.data.originalHeight
                this.props.width = this.data.width
                this.props.key = this.data.key
                this.props.secret = this.data.secret
                this.props.sandbox = (this.data.sandbox === 'true')
                this.setSize(this.props.width, this.props.originalHeight)
                this.dom['toolbar'].style.height = this.props.toolbarHeight + 'px'
                this.dom['auth-panel'].style.width = this.props.width + 'px'
                this.dom['auth-panel'].style.height = this.props.height + 'px'
                this.createWidgets()
            }
        },
        createWidgets: {
            method: function() {
                var phone = this
                var panelHeight = this.props.height
                this.props.conversation = undefined;
                this.props.contactDetail = undefined;
                this.props.notification = w('notification', {})
               

                if (this.data.firstLevel) {
                    var names = this.data.firstLevel.split(',')
                    this.props.authPanel = w('auth-panel', {
                        shadowRoot: phone.data.shadowRoot,
                        data: {
                            ...phone.data,
                            oauth: true
                        },
                        actions: factory.create('auth-panel', {
                            login: {
                                after: function() {
                                    this.unmount()
                                    phone.loadData();
                                    if (names.length > 1) {
                                        if (phone.data.shadowRoot)
                                            phone.props.toolbar.mount(phone.data.shadowRoot.querySelector('#toolbar'))
                                        else
                                            phone.props.toolbar.mount('#toolbar')
                                    } else {
                                        phone.props.panels[0].mount('#first-level-0')
                                        phone.dom['toolbar'].parentNode.removeChild(phone.dom['toolbar'])
                                    }
                                    phone.dom['auth-panel'].style['z-index'] = '-1'
                                }
                            }
                        })
                    });
                    console.log(names.length);
                    console.log(panelHeight);
                    if (names.length > 1) {
                        var toolbar = this.props.toolbar = w('tool-bar', {
                            shadowRoot: phone.data.shadowRoot,
                            data : phone.data,
                            actions: {
                                mount: {
                                    after: function() {
                                        phone.props.panels[0].mount('#first-level-0')
                                    }
                                }
                            }
                        })
                        panelHeight = this.props.height - this.props.toolbarHeight
                    } else if (names.length === 1) {
                        this.props.minimizedHeight = this.props.minimizedHeight - this.props.toolbarHeight
                    }

                    names.forEach((name, index) => {
                        var widget
                        if (name === 'call-log') {
                            widget = this.props.callLog = w('call-log', {
                                shadowRoot: phone.data.shadowRoot,
                                actions: factory.create('call-log')
                            })
                            if (names.length > 1) {
                                toolbar.clickItem(
                                    toolbar.addItem('<span class="icon-uniC8"></span><span class="icon-RC_shapes_2-30_pressed"></span>'), 
                                    phone.switchWidgets(
                                        panel,
                                        '#first-level' + index, 
                                        index
                                    )
                                )
                            }
                        } else if (name === 'time-line') {
                            if (!this.props.callPanel) {
                                this.props.callPanel = w('call-panel', {
                                    shadowRoot: phone.data.shadowRoot,
                                    data: {
                                        ...phone.data,
                                        target: '#call-panel',
                                        width: this.props.width,
                                        height: panelHeight
                                    },
                                    actions: factory.create('call-panel')
                                })
                            }
                            
                            widget = this.props.timeline = w('time-line', {
                                shadowRoot: phone.data.shadowRoot,
                                actions: factory.create('time-line', {
                                    search: {
                                        method: function() {
                                            contacts.dom.searchText.value = this.dom.searchText.value 
                                            contacts.search()
                                        }
                                    },
                                    enterItem: {
                                        after: function() {
                                            var contact = this.props.selectedContent.contact
                                            var toNumber = contact.phoneNumber[0]
                                            this.props.currentConv = conv(contact, () => {
                                                this.props.currentConv.unmount()
                                            }, {
                                                width: phone.props.width,
                                                height: panelHeight,
                                                toNumber,
                                                toExt: contact.extension,
                                                anchorContent: this.props.selectedContent,
                                                remoteVideo: phone.props.callPanel.props.remoteVideo,
                                                localVideo: phone.props.callPanel.props.localVideo,
                                            }, {
                                                callout: {
                                                    after: function() {
                                                        phone.props.callPanel.setName(
                                                            this.props.toNumber || this.props.toExt
                                                        )
                                                        phone.props.callPanel.mount('#call-panel')
                                                    }
                                                }
                                            })
                                            this.props.currentConv.mount('#conversation')
                                        }
                                    }
                                })
                            })
                            if (names.length > 1) {
                                toolbar.clickItem(
                                    toolbar.addItem('<span class="icon-uni2487"></span></span><span class="icon-RC_shapes_1_30_pressed"></span>'), 
                                    phone.switchWidgets(
                                        widget,
                                        '#first-level' + index, 
                                        index
                                    )
                                )
                            }
                        } else if (name === 'contacts') {
                            widget = this.props.contacts = w('contacts', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {},
                                actions: factory.create('contacts', {
                                    selectContact: {
                                        method: function() {
                                            var contact = 
                                                (this.props.relateContacts && 
                                                this.props.relateContacts[this.props.selectedContact.id]) ||
                                                this.props.contacts[this.props.selectedContact.id]
                                            var conversation = phone.props.timeline.props.currentConv = conv(contact, () => {
                                                phone.props.timeline.mount('#contact-detail')
                                            })
                                            conversation.mount('#contact-detail')
                                        }
                                    },
                                })
                            })
                            if (names.length > 1) {
                                toolbar.clickItem(
                                    toolbar.addItem('<span class="icon-uni7D"></span><span class="icon-contact_info_pressed"></span>'), 
                                    phone.switchWidgets(
                                        widget,
                                        '#first-level' + index, 
                                        index
                                    )
                                )
                            }
                        } else if (name === 'dial-pad') {
                            if (!this.props.callPanel) {
                                this.props.callPanel = w('call-panel', {
                                    shadowRoot: phone.data.shadowRoot,
                                    data: {
                                        ...phone.data,
                                        target: '#call-panel',
                                        width: this.props.width,
                                        height: panelHeight
                                    },
                                    actions: factory.create('call-panel')
                                })
                            }
                            widget = this.props.dialPad = w('dial-pad', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {
                                    ...phone.data,
                                    remoteVideo: phone.props.callPanel.props.remoteVideo,
                                    localVideo: phone.props.callPanel.props.localVideo,
                                },
                                actions: factory.create('dial-pad', {
                                    mount: {
                                        after: function() {
                                            var isWebRTCSupported = false;
                                            [
                                                'RTCPeerConnection', 
                                                'webkitRTCPeerConnection', 
                                                'mozRTCPeerConnection', 
                                                'RTCIceGatherer'
                                            ].forEach(function(item) {
                                                if (isWebRTCSupported) return
                                                isWebRTCSupported = (item in window)
                                            })

                                            if (!isWebRTCSupported) {
                                                this.disable('This browser does not support WebRTC.')
                                            }
                                        }
                                    },
                                    callout: {
                                        after: function() {
                                            phone.props.callPanel.setName(this.props.toNumber)
                                            phone.props.callPanel.mount('#call-panel')
                                        },
                                        // error: function(e) {
                                        //     console.error(e);
                                        //     phone.props.notification.show('#notification', 4000)
                                        //     phone.props.notification.msg(e.message || e)
                                        // }
                                    },
                                    numberChange: {
                                        after: function () {
                                            phone.props.ee.trigger('dialing', [this.props.toNumber])
                                        }
                                    }
                                })
                            });
                            
                            this.props.callPanelIncoming = w('call-panel-incoming', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {
                                    target: '#call-panel-incoming',
                                    ...phone.data,
                                    width: this.props.width,
                                    height: panelHeight,
                                    remoteVideo: phone.props.callPanel.props.remoteVideo,
                                    localVideo: phone.props.callPanel.props.localVideo,
                                },
                                actions: factory.create('call-panel-incoming', {
                                    mount: {
                                        after: function() {
                                            if (phone.props.height === phone.props.minimizedHeight) {
                                                this.simplify(true)
                                            } else {
                                                this.simplify(false)
                                            }
                                            phone.resize(Math.max(280, phone.props.height))
                                        }
                                    },
                                    unmount: {
                                        after: function() {
                                            if (phone.props.height !== phone.props.originalHeight)
                                                phone.resize(phone.props.minimizedHeight)
                                        }
                                    },
                                    accept: {
                                        after: function() {
                                            this.unmount()
                                            phone.props.callPanel.setName(this.props.name)
                                            phone.props.callPanel.mount('#call-panel')
                                            phone.props.callPanel.start()
                                            phone.resize(phone.props.originalHeight)
                                        }
                                    },
                                    ignore: {
                                        after: function() {
                                            phone.resize(phone.props.minimizedHeight)
                                        }
                                    },
                                    // message: {
                                    //     after: function() {
                                    //         this.unmount()
                                    //     }
                                    // }
                                })
                            })
                            if (names.length > 1) {
                                toolbar.clickItem(
                                    toolbar.addItem('<span class="icon-uniA4"></span><span class="icon-RC_shapes_1-40_pressed"></span>'), 
                                    phone.switchWidgets(
                                        widget,
                                        '#first-level' + index, 
                                        index
                                    )
                                )
                            }
                        } else if (name === 'conference') {
                            widget = this.props.conference = w('conference',{
                                data : phone.data,
                                actions: factory.create('conference', {
                                    inviteWithText: {
                                        method: function() {
                                            
                                        }
                                    },
                                    joinAsHost: {
                                        method: function() {
                                            phone.dom.container.style.transform = 'translateX(0px)';
                                            phone.props.dialPad.mount('#dial-pad');
                                            phone.props.dialPad.number(phone.props.conference.props.dialInNumber)
                                        }
                                    }
                                })
                            })
                            if (names.length > 1) {
                                toolbar.clickItem(
                                    toolbar.addItem('<span class="icon-uniA3"></span>'), 
                                    phone.switchWidgets(
                                        widget,
                                        '#first-level' + index, 
                                        index
                                    )
                                )
                            }
                        } else if (name === 'call-panel-incoming') { // workaround for inContact
                            this.props.callPanel = w('call-panel', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {
                                    ...phone.data,
                                    target: '#call-panel',
                                    width: this.props.width,
                                    height: panelHeight
                                },
                                actions: factory.create('call-panel')
                            })
                            this.props.callPanelIncoming = w('call-panel-incoming', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {
                                    target: '#call-panel-incoming',
                                    ...phone.data,
                                    width: this.props.width,
                                    height: panelHeight,
                                    remoteVideo: phone.props.callPanel.props.remoteVideo,
                                    localVideo: phone.props.callPanel.props.localVideo,
                                },
                                actions: factory.create('call-panel-incoming', {
                                    mount: {
                                        after: function() {
                                            if (phone.props.height === phone.props.minimizedHeight) {
                                                this.simplify(true)
                                            } else {
                                                this.simplify(false)
                                            }
                                            phone.resize(Math.max(250, phone.props.height))
                                        }
                                    },
                                    unmount: {
                                        after: function() {
                                            if (phone.props.height != phone.props.originalHeight)
                                                phone.resize(phone.props.minimizedHeight)
                                        }
                                    },
                                    accept: {
                                        after: function() {
                                            this.unmount()
                                            phone.props.callPanel.setName(this.props.name)
                                            phone.props.callPanel.mount('#call-panel')
                                            phone.props.callPanel.start()
                                            phone.resize(phone.props.originalHeight)
                                        }
                                    },
                                    ignore: {
                                        after: function() {
                                            phone.resize(phone.props.minimizedHeight)
                                        }
                                    },
                                    // message: {
                                    //     after: function() {
                                    //         this.unmount()
                                    //     }
                                    // }
                                })
                            })
                        }
                        if (widget) {
                            this.props.panels.push(widget)
                            var div = document.createElement('div')
                            div.classList.add('panel')
                            div.classList.add('float-left')
                            div.style.width = this.props.width + 'px'
                            div.style.height = this.props.height+ 'px'
                            if (names.length > 1)
                                div.style.height = (this.props.height - this.props.toolbarHeight) + 'px'
                            div.setAttribute('id', 'first-level-' + (this.props.panels.length - 1))
                            this.dom.container.appendChild(div)
                        }
                    })
                }
            }
        },
        switchWidgets: {
            method: function(finish, source, target, index) {
                return () => {
                    if (this.props.conversation) {
                        this.props.conversation.destroy()
                        this.props.conversation = null
                    }
                    if (this.props.contactDetail){
                        this.props.contactDetail.destroy();
                        this.props.contactDetail = null;
                    }
                    if (this.props.callPanel && this.props.callPanel._mounted){
                        this.props.callPanel.minimize()
                    }
                    if (this.props.currentIndex === index)
                        return
                    if (this.props.isTranistioning)
                        return
                    var h = e => {
                        this.props.panels.filter((p, idx) => idx !== index).forEach(p => p.unmount())
                        this.dom.container.removeEventListener('transitionend', h)
                        this.props.isTranistioning = false
                    }
                    this.props.isTranistioning = true
                    this.props.currentIndex = index
                    this.dom.container.style.transform = `translateX(${0 - index * this.props.width}px)`;
                    this.dom.container.addEventListener('transitionend', h)
                    source.mount('#first-level-' + index);
                }
            }
        },
        mount: {
            after: function() {
                this.props.authPanel.mount('#auth-panel')
                this.checkLogin().then(loggedin => {
                    if (loggedin) {
                        this.loadData()
                        if (this.props.panels.length === 1) {
                            this.props.panels[0].mount('#first-level-0')
                            this.dom['toolbar'].parentNode.removeChild(this.dom['toolbar'])
                        } else if (this.props.panels.length === 0) {
                            this.dom['toolbar'].parentNode.removeChild(this.dom['toolbar'])
                        } else {
                            this.props.toolbar.mount('#toolbar')
                        }
                        this.dom['auth-panel'].style['z-index'] = '-1'
                    } else {
                        this.props.authPanel.mount('#auth-panel')
                    }
                })
                this.props.ee.trigger('ready')
                // this.checkLogin().then(isLoggedIn => {
                //     if (this.data.shadowRoot)
                //         this.props.authPanel.mount(this.data.shadowRoot.querySelector('#auth-panel'))
                //     else
                //         this.props.authPanel.mount('#auth-panel')
                // }).catch(err => console.error(err))
            }
        },
        logout: {
            after: function() {
                this.props.authPanel.mount(this.dom['auth-panel'])
                this.dom['auth-panel'].style['z-index'] = '5'
                this.props.toolbar.unmount()
                this.props.panels.forEach(panel => panel.unmount())
                this.props.currentIndex = 0
                this.dom.container.style.transform = `translateX(0px)`;
            }
        }
    })
    this.on('click', function(e) {
        if (e.target === this.dom.resize) {
            this.resize()
        } else {
            // if (this.props.height === this.props.minimizedHeight) {
            //     this.resize()
            // }
        }
        if (e.target === this.dom.remove) {
            this.props.ee.trigger('unmount')
            this.unmount()
        } else if (e.target === this.dom.logout) {
            this.logout()
        }
    })

    function conv(contact, afterBack, options = {}, actions = {}) {
        return w('conversation-advanced', {
            data: {
                ...options,
                new: true,
                contact: contact,
            },
            actions: factory.create('conversation-advanced', {
                ...actions,
                back: {
                    after: function() {
                        this.unmount()
                        if (afterBack && typeof afterBack === 'function')
                            afterBack()
                    }
                },
            })
        })
    }
})

//# sourceURL=rc-phone.html
</script>
