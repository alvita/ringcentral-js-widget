<template>
    <div class='rc-panel rc-timeline'>
        <div class='rc-panel__content rc-panel__content--full' data-info='content'>
            <div class='rc-timeline__loading' data-info='loading'>Loading ...</div>
            <div class='rc-timeline__list' data-info='timeline'>
                <!-- timeline-item -->
            </div>
            <div class='rc-timeline__mask display-none' data-info='mask'></div>
        </div>
    </div>
</template>
<script>
w.register(function() {
    var syncedMessages = []
    this.data = {}
    this.actions= {
        init: {
            after: function() {
                this.props.mounted = false
                this.props.latestMessage = null
            }
        },
        mount: {
            after: function() {
                if (!this.props.mounted) {
                    this.fetchData()
                    this.props.mounted = true
                }
            }
        },
        fetchData: {
            method: function(finish) {
                return finish()
            },
            after: function(contents) {
                this.dom.loading.classList.add('display-none')
                if (!contents || !contents[0])
                    return
                this.props.latestMessage = contents[0]
                contents.forEach((content, index) => this.addLine(content, false, index * 30))
            }
        },
        updateTimeline: {
            after: function(contents) {
                // FIXME: The action of combining messages should be in service
                contents
                // Avoid duplicated notifications
                .filter(content => syncedMessages.indexOf(content.id) === -1)
                .forEach(content => {
                    if (this.props.latestMessage &&
                        this.props.latestMessage.type === content.type &&
                        this.props.latestMessage.contact.id === content.contact.id) {

                        this.props.latestMessage.others = this.props.latestMessage.others || []
                        content.others = content.others || []
                        content.others.push(this.props.latestMessage)
                        content.others = content.others.concat(this.props.latestMessage.others)
                        this.props.latestMessage.widget.unmount()
                    }
                    this.addLine(content, true)
                    this.props.latestMessage = content
                    syncedMessages.push(content.id)
                })
            }
        },
        addLine: {
            after: function(content, prepend, showingDelay) {
                var parent = this
                var item = w('time-line-item', {
                    data: {
                        ...content,
                        showingDelay
                    },
                    actions: {
                        enter: {
                            after: function() {
                                parent.props.selectedContent = this.props.selectedMessage || this.props.content
                                parent.enterItem()
                            }
                        }
                    }
                })
                content.widget = item
                item.mount(this.dom.timeline, prepend)
            }
        },
        search: {
            method: function(finish) {
                return finish()
            }
        },
        focusSearchBox: {
            method: function(finish) {
                return finish()
            },
            after: function() {}
        },
        blurSearchBox: {
            method: function(finish) {
                return finish()
            },
            after: function() {}
        },
        switchContent: {
            method: function() {},
            after: function() {}
        },
        enterItem: {
            method: function() {},
            after: function() {}
        }
    }
})
//# sourceURL=time-line.html
</script>
<style>
@import "src/styles/variables.css";
@import "src/styles/mixins.css";
$timeline-gray: #878787;
.rc-timeline {
    > .rc-panel__content {
        overflow: auto;
    }
    &__list {
        @mixin padding-normal;
    }
    &__mask {
        position: absolute;
        width:  100%;
        height: 100%;
        top: 0;
    }
    &__loading {
        @mixin padding-large;
        color: #878787;
        text-align: center;
    }
}


.rc-timeline-item {
    @mixin padding-normal;
    @mixin shadow-1;
    margin-bottom:  5px;
    overflow: hidden;
    transition: background-color .5s ease-in-out;
    cursor: pointer;
    &__line {
        margin-bottom: 10px;
    }
    &__icon {
    }
    &__contact {
        font-size: .9em;
    }
    &__time {
        float: right;
        font-size: .7em;
        color: $timeline-gray;
    }
    &__subject {
        font-size: .8em;
        overflow:       hidden;
        text-overflow:  ellipsis;
    }
    &__count {
        @mixin padding-normal;
        position: absolute;
        top:    0;
        right:  0;
        font-size: .8em;
        > .__number {
            color: $timeline-gray;
        }
        &:hover > .__number {
            color: #000;
        }
    }
    &__content {
        @mixin padding-normal;
        position: relative;
    }
    &__collapse {
        @mixin shadow-1;
        height: 0;
        overflow: hidden;
        transition: height .350s cubic-bezier(0.4, 0.0, 0.2, 1);;
        > .timeline-extra {
            @mixin padding-normal;
            font-size: .8em;
        }
    }
    &:hover {
        @mixin shadow-2;
        /*background-color: #eee;*/
    }

    .timeline-extra {
        &__content {
            
        }
        &:hover {
            background-color: #eee;
        }
    }
}

</style>
